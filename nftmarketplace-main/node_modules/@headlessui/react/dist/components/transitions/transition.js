import u,{Fragment as B,createContext as W,useContext as _,useEffect as v,useMemo as q,useRef as C,useState as U}from"react";import{Features as de,forwardRefWithAs as j,render as z,RenderStrategy as T}from"../../utils/render.js";import{OpenClosedProvider as fe,State as P,useOpenClosed as J}from"../../internal/open-closed.js";import{match as V}from"../../utils/match.js";import{microTask as Te}from"../../utils/micro-task.js";import{useId as pe}from"../../hooks/use-id.js";import{useIsMounted as me}from"../../hooks/use-is-mounted.js";import{useIsoMorphicEffect as ce}from"../../hooks/use-iso-morphic-effect.js";import{useLatestValue as I}from"../../hooks/use-latest-value.js";import{useServerHandoffComplete as K}from"../../hooks/use-server-handoff-complete.js";import{useSyncRefs as Q}from"../../hooks/use-sync-refs.js";import{useTransition as he}from"../../hooks/use-transition.js";import{useEvent as X}from"../../hooks/use-event.js";function m(e=""){return e.split(" ").filter(n=>n.trim().length>1)}let N=W(null);N.displayName="TransitionContext";var ge=(t=>(t.Visible="visible",t.Hidden="hidden",t))(ge||{});function ve(){let e=_(N);if(e===null)throw new Error("A <Transition.Child /> is used but it is missing a parent <Transition /> or <Transition.Root />.");return e}function Ce(){let e=_(R);if(e===null)throw new Error("A <Transition.Child /> is used but it is missing a parent <Transition /> or <Transition.Root />.");return e}let R=W(null);R.displayName="NestingContext";function L(e){return"children"in e?L(e.children):e.current.filter(({state:n})=>n==="visible").length>0}function Y(e){let n=I(e),t=C([]),r=me(),i=X((o,l=T.Hidden)=>{let s=t.current.findIndex(({id:d})=>d===o);s!==-1&&(V(l,{[T.Unmount](){t.current.splice(s,1)},[T.Hidden](){t.current[s].state="hidden"}}),Te(()=>{var d;!L(t)&&r.current&&((d=n.current)==null||d.call(n))}))}),c=X(o=>{let l=t.current.find(({id:s})=>s===o);return l?l.state!=="visible"&&(l.state="visible"):t.current.push({id:o,state:"visible"}),()=>i(o,T.Unmount)});return q(()=>({children:t,register:c,unregister:i}),[c,i,t])}function be(){}let Se=["beforeEnter","afterEnter","beforeLeave","afterLeave"];function Z(e){var t;let n={};for(let r of Se)n[r]=(t=e[r])!=null?t:be;return n}function Ee(e){let n=C(Z(e));return v(()=>{n.current=Z(e)},[e]),n}let xe="div",$=de.RenderStrategy,ee=j(function(n,t){let{beforeEnter:r,afterEnter:i,beforeLeave:c,afterLeave:o,enter:l,enterFrom:s,enterTo:d,entered:b,leave:S,leaveFrom:E,leaveTo:F,...p}=n,h=C(null),x=Q(h,t),[f,A]=U("visible"),D=p.unmount?T.Unmount:T.Hidden,{show:g,appear:te,initial:re}=ve(),{register:y,unregister:H}=Ce(),w=C(null),a=pe(),ne=C(!1),G=Y(()=>{ne.current||(A("hidden"),H(a))});v(()=>{if(!!a)return y(a)},[y,a]),v(()=>{if(D===T.Hidden&&!!a){if(g&&f!=="visible"){A("visible");return}V(f,{["hidden"]:()=>H(a),["visible"]:()=>y(a)})}},[f,a,y,H,g,D]);let ie=I({enter:m(l),enterFrom:m(s),enterTo:m(d),entered:m(b),leave:m(S),leaveFrom:m(E),leaveTo:m(F)}),se=Ee({beforeEnter:r,afterEnter:i,beforeLeave:c,afterLeave:o}),O=K();v(()=>{if(O&&f==="visible"&&h.current===null)throw new Error("Did you forget to passthrough the `ref` to the actual DOM node?")},[h,f,O]);let M=re&&!te,oe=(()=>!O||M||w.current===g?"idle":g?"enter":"leave")();he({container:h,classes:ie,events:se,direction:oe,onStart:I(()=>{}),onStop:I(ue=>{ue==="leave"&&!L(G)&&(A("hidden"),H(a))})}),v(()=>{!M||(D===T.Hidden?w.current=null:w.current=g)},[g,M,f]);let le=p,ae={ref:x};return u.createElement(R.Provider,{value:G},u.createElement(fe,{value:V(f,{["visible"]:P.Open,["hidden"]:P.Closed})},z({ourProps:ae,theirProps:le,defaultTag:xe,features:$,visible:f==="visible",name:"Transition.Child"})))}),k=j(function(n,t){let{show:r,appear:i=!1,unmount:c,...o}=n,l=Q(t);K();let s=J();if(r===void 0&&s!==null&&(r=V(s,{[P.Open]:!0,[P.Closed]:!1})),![!0,!1].includes(r))throw new Error("A <Transition /> is used but it is missing a `show={true | false}` prop.");let[d,b]=U(r?"visible":"hidden"),S=Y(()=>{b("hidden")}),[E,F]=U(!0),p=C([r]);ce(()=>{E!==!1&&p.current[p.current.length-1]!==r&&(p.current.push(r),F(!1))},[p,r]);let h=q(()=>({show:r,appear:i,initial:E}),[r,i,E]);v(()=>{r?b("visible"):L(S)||b("hidden")},[r,S]);let x={unmount:c};return u.createElement(R.Provider,{value:S},u.createElement(N.Provider,{value:h},z({ourProps:{...x,as:B,children:u.createElement(ee,{ref:l,...x,...o})},theirProps:{},defaultTag:B,features:$,visible:d==="visible",name:"Transition"})))}),ye=j(function(n,t){let r=_(N)!==null,i=J()!==null;return u.createElement(u.Fragment,null,!r&&i?u.createElement(k,{ref:t,...n}):u.createElement(ee,{ref:t,...n}))}),We=Object.assign(k,{Child:ye,Root:k});export{We as Transition};
