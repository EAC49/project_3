import L,{createContext as j,createRef as ie,useCallback as R,useContext as $,useEffect as U,useMemo as M,useReducer as de,useRef as Y,useState as ve}from"react";import{match as x}from"../../utils/match.js";import{forwardRefWithAs as W,render as V,Features as q}from"../../utils/render.js";import{optionalRef as Te,useSyncRefs as H}from"../../hooks/use-sync-refs.js";import{useId as D}from"../../hooks/use-id.js";import{Keys as h}from"../keyboard.js";import{isDisabledReactIssue7711 as se}from"../../utils/bugs.js";import{getFocusableElements as ye,Focus as k,focusIn as G,isFocusableElement as me,FocusableMode as Ee}from"../../utils/focus-management.js";import{OpenClosedProvider as Se,State as z,useOpenClosed as ue}from"../../internal/open-closed.js";import{useResolveButtonType as be}from"../../hooks/use-resolve-button-type.js";import{useOutsideClick as ge}from"../../hooks/use-outside-click.js";import{getOwnerDocument as Ae}from"../../utils/owner.js";import{useOwnerDocument as Q}from"../../hooks/use-owner.js";import{useEventListener as fe}from"../../hooks/use-event-listener.js";import{Hidden as X,Features as Z}from"../../internal/hidden.js";import{useEvent as ee}from"../../hooks/use-event.js";import{useTabDirection as ce,Direction as _}from"../../hooks/use-tab-direction.js";import"../../utils/micro-task.js";var Ce=(f=>(f[f.Open=0]="Open",f[f.Closed=1]="Closed",f))(Ce||{}),Re=(r=>(r[r.TogglePopover=0]="TogglePopover",r[r.ClosePopover=1]="ClosePopover",r[r.SetButton=2]="SetButton",r[r.SetButtonId=3]="SetButtonId",r[r.SetPanel=4]="SetPanel",r[r.SetPanelId=5]="SetPanelId",r))(Re||{});let Oe={[0]:l=>({...l,popoverState:x(l.popoverState,{[0]:1,[1]:0})}),[1](l){return l.popoverState===1?l:{...l,popoverState:1}},[2](l,t){return l.button===t.button?l:{...l,button:t.button}},[3](l,t){return l.buttonId===t.buttonId?l:{...l,buttonId:t.buttonId}},[4](l,t){return l.panel===t.panel?l:{...l,panel:t.panel}},[5](l,t){return l.panelId===t.panelId?l:{...l,panelId:t.panelId}}},te=j(null);te.displayName="PopoverContext";function J(l){let t=$(te);if(t===null){let f=new Error(`<${l} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(f,J),f}return t}let oe=j(null);oe.displayName="PopoverAPIContext";function re(l){let t=$(oe);if(t===null){let f=new Error(`<${l} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(f,re),f}return t}let ne=j(null);ne.displayName="PopoverGroupContext";function Pe(){return $(ne)}let le=j(null);le.displayName="PopoverPanelContext";function Le(){return $(le)}function Ie(l,t){return x(t.type,Oe,l,t)}let Fe="div",Me=W(function(t,f){var i;let e=`headlessui-popover-button-${D()}`,c=`headlessui-popover-panel-${D()}`,a=Y(null),r=H(f,Te(o=>{a.current=o})),b=de(Ie,{popoverState:1,button:null,buttonId:e,panel:null,panelId:c,beforePanelSentinel:ie(),afterPanelSentinel:ie()}),[{popoverState:E,button:n,panel:v,beforePanelSentinel:s,afterPanelSentinel:B},p]=b,y=Q((i=a.current)!=null?i:n);U(()=>p({type:3,buttonId:e}),[e,p]),U(()=>p({type:5,panelId:c}),[c,p]);let P=M(()=>{if(!n||!v)return!1;for(let o of document.querySelectorAll("body > *"))if(Number(o==null?void 0:o.contains(n))^Number(o==null?void 0:o.contains(v)))return!0;return!1},[n,v]),T=M(()=>({buttonId:e,panelId:c,close:()=>p({type:1})}),[e,c,p]),m=Pe(),S=m==null?void 0:m.registerPopover,I=R(()=>{var o;return(o=m==null?void 0:m.isFocusWithinPopoverGroup())!=null?o:(y==null?void 0:y.activeElement)&&((n==null?void 0:n.contains(y.activeElement))||(v==null?void 0:v.contains(y.activeElement)))},[m,n,v]);U(()=>S==null?void 0:S(T),[S,T]),fe(y==null?void 0:y.defaultView,"focus",o=>{var d,O,F,w;E===0&&(I()||!n||!v||(O=(d=s.current)==null?void 0:d.contains)!=null&&O.call(d,o.target)||(w=(F=B.current)==null?void 0:F.contains)!=null&&w.call(F,o.target)||p({type:1}))},!0),ge([n,v],(o,d)=>{E===0&&(p({type:1}),me(d,Ee.Loose)||(o.preventDefault(),n==null||n.focus()))});let C=R(o=>{p({type:1});let d=(()=>o?o instanceof HTMLElement?o:o.current instanceof HTMLElement?o.current:n:n)();d==null||d.focus()},[p,n]),N=M(()=>({close:C,isPortalled:P}),[C,P]),u=M(()=>({open:E===0,close:C}),[E,C]),A=t,g={ref:r};return L.createElement(te.Provider,{value:b},L.createElement(oe.Provider,{value:N},L.createElement(Se,{value:x(E,{[0]:z.Open,[1]:z.Closed})},V({ourProps:g,theirProps:A,slot:u,defaultTag:Fe,name:"Popover"}))))}),Be="button",he=W(function(t,f){let[e,c]=J("Popover.Button"),{isPortalled:a}=re("Popover.Button"),r=Y(null),b=`headlessui-focus-sentinel-${D()}`,E=Pe(),n=E==null?void 0:E.closeOthers,v=Le(),s=v===null?!1:v===e.panelId,B=H(r,f,s?null:i=>c({type:2,button:i})),p=H(r,f),y=Q(r),P=R(i=>{var o,d,O;if(s){if(e.popoverState===1)return;switch(i.key){case h.Space:case h.Enter:i.preventDefault(),(d=(o=i.target).click)==null||d.call(o),c({type:1}),(O=e.button)==null||O.focus();break}}else switch(i.key){case h.Space:case h.Enter:i.preventDefault(),i.stopPropagation(),e.popoverState===1&&(n==null||n(e.buttonId)),c({type:0});break;case h.Escape:if(e.popoverState!==0)return n==null?void 0:n(e.buttonId);if(!r.current||(y==null?void 0:y.activeElement)&&!r.current.contains(y.activeElement))return;i.preventDefault(),i.stopPropagation(),c({type:1});break}},[c,e.popoverState,e.buttonId,e.button,e.panel,r,n,s]),T=R(i=>{s||i.key===h.Space&&i.preventDefault()},[s]),m=R(i=>{var o,d;se(i.currentTarget)||t.disabled||(s?(c({type:1}),(o=e.button)==null||o.focus()):(i.preventDefault(),i.stopPropagation(),e.popoverState===1&&(n==null||n(e.buttonId)),(d=e.button)==null||d.focus(),c({type:0})))},[c,e.button,e.popoverState,e.buttonId,t.disabled,n,s]),S=e.popoverState===0,I=M(()=>({open:S}),[S]),C=be(t,r),N=t,u=s?{ref:p,type:C,onKeyDown:P,onClick:m}:{ref:B,id:e.buttonId,type:C,"aria-expanded":t.disabled?void 0:e.popoverState===0,"aria-controls":e.panel?e.panelId:void 0,onKeyDown:P,onKeyUp:T,onClick:m},A=ce(),g=ee(()=>{let i=e.panel;if(!i)return;function o(){x(A.current,{[_.Forwards]:()=>G(i,k.First),[_.Backwards]:()=>G(i,k.Last)})}o()});return L.createElement(L.Fragment,null,V({ourProps:u,theirProps:N,slot:I,defaultTag:Be,name:"Popover.Button"}),S&&!s&&a&&L.createElement(X,{id:b,features:Z.Focusable,as:"button",type:"button",onFocus:g}))}),xe="div",He=q.RenderStrategy|q.Static,De=W(function(t,f){let[{popoverState:e},c]=J("Popover.Overlay"),a=H(f),r=`headlessui-popover-overlay-${D()}`,b=ue(),E=(()=>b!==null?b===z.Open:e===0)(),n=R(p=>{if(se(p.currentTarget))return p.preventDefault();c({type:1})},[c]),v=M(()=>({open:e===0}),[e]);return V({ourProps:{ref:a,id:r,"aria-hidden":!0,onClick:n},theirProps:t,slot:v,defaultTag:xe,features:He,visible:E,name:"Popover.Overlay"})}),ke="div",Ge=q.RenderStrategy|q.Static,_e=W(function(t,f){let{focus:e=!1,...c}=t,[a,r]=J("Popover.Panel"),{close:b,isPortalled:E}=re("Popover.Panel"),n=`headlessui-focus-sentinel-before-${D()}`,v=`headlessui-focus-sentinel-after-${D()}`,s=Y(null),B=H(s,f,u=>{r({type:4,panel:u})}),p=Q(s),y=ue(),P=(()=>y!==null?y===z.Open:a.popoverState===0)(),T=R(u=>{var A;switch(u.key){case h.Escape:if(a.popoverState!==0||!s.current||(p==null?void 0:p.activeElement)&&!s.current.contains(p.activeElement))return;u.preventDefault(),u.stopPropagation(),r({type:1}),(A=a.button)==null||A.focus();break}},[a,s,r]);U(()=>{var u;t.static||a.popoverState===1&&((u=t.unmount)!=null?u:!0)&&r({type:4,panel:null})},[a.popoverState,t.unmount,t.static,r]),U(()=>{if(!e||a.popoverState!==0||!s.current)return;let u=p==null?void 0:p.activeElement;s.current.contains(u)||G(s.current,k.First)},[e,s,a.popoverState]),fe(p==null?void 0:p.defaultView,"focus",()=>{var A,g,i,o,d;if(!e||a.popoverState!==0||!s.current)return;let u=p==null?void 0:p.activeElement;u&&(((A=s.current)==null?void 0:A.contains(u))||((i=(g=a.beforePanelSentinel.current)==null?void 0:g.contains)==null?void 0:i.call(g,u))||((d=(o=a.afterPanelSentinel.current)==null?void 0:o.contains)==null?void 0:d.call(o,u)))||r({type:1})},!0);let m=M(()=>({open:a.popoverState===0,close:b}),[a,b]),S={ref:B,id:a.panelId,onKeyDown:T,tabIndex:-1},I=ce(),C=ee(()=>{let u=s.current;if(!u)return;function A(){x(I.current,{[_.Forwards]:()=>{G(u,k.First)},[_.Backwards]:()=>{var g;(g=a.button)==null||g.focus({preventScroll:!0})}})}A()}),N=ee(()=>{let u=s.current;if(!u)return;function A(){x(I.current,{[_.Forwards]:()=>{var F,w,ae;if(!a.button)return;let g=ye(),i=g.indexOf(a.button),o=g.slice(0,i+1),O=[...g.slice(i+1),...o];for(let K of O.slice())if(((w=(F=K==null?void 0:K.id)==null?void 0:F.startsWith)==null?void 0:w.call(F,"headlessui-focus-sentinel-"))||((ae=a.panel)==null?void 0:ae.contains(K))){let pe=O.indexOf(K);pe!==-1&&O.splice(pe,1)}G(O,k.First,!1)},[_.Backwards]:()=>G(u,k.Last)})}A()});return L.createElement(le.Provider,{value:a.panelId},P&&E&&L.createElement(X,{id:n,ref:a.beforePanelSentinel,features:Z.Focusable,as:"button",type:"button",onFocus:C}),V({ourProps:S,theirProps:c,slot:m,defaultTag:ke,features:Ge,visible:P,name:"Popover.Panel"}),P&&E&&L.createElement(X,{id:v,ref:a.afterPanelSentinel,features:Z.Focusable,as:"button",type:"button",onFocus:N}))}),Ne="div",we=W(function(t,f){let e=Y(null),c=H(e,f),[a,r]=ve([]),b=R(P=>{r(T=>{let m=T.indexOf(P);if(m!==-1){let S=T.slice();return S.splice(m,1),S}return T})},[r]),E=R(P=>(r(T=>[...T,P]),()=>b(P)),[r,b]),n=R(()=>{var m;let P=Ae(e);if(!P)return!1;let T=P.activeElement;return(m=e.current)!=null&&m.contains(T)?!0:a.some(S=>{var I,C;return((I=P.getElementById(S.buttonId))==null?void 0:I.contains(T))||((C=P.getElementById(S.panelId))==null?void 0:C.contains(T))})},[e,a]),v=R(P=>{for(let T of a)T.buttonId!==P&&T.close()},[a]),s=M(()=>({registerPopover:E,unregisterPopover:b,isFocusWithinPopoverGroup:n,closeOthers:v}),[E,b,n,v]),B=M(()=>({}),[]),p=t,y={ref:c};return L.createElement(ne.Provider,{value:s},V({ourProps:y,theirProps:p,slot:B,defaultTag:Ne,name:"Popover.Group"}))}),Tt=Object.assign(Me,{Button:he,Overlay:De,Panel:_e,Group:we});export{Tt as Popover};
